<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Drag and drop CZML files onto the Cesium Viewer Widget to visualize time dynamic data.">
    <title>Cesium Demo</title>
    <script>
    var Sandcastle = {};
    Sandcastle.declare = function () {};
    Sandcastle.highlight = function () {};
    Sandcastle.registered = [];
    if (window.location.protocol === 'file:') {
        if (confirm("You must host this app on a web server.\nSee contributor's guide for more info?")) {
            window.location = 'https://github.com/AnalyticalGraphicsInc/cesium/wiki/Contributor%27s-Guide';
        }
    }
    </script>
    <script data-dojo-config="async: 1, tlmSiblingOfDojo: 0" src="../../../ThirdParty/dojo-release-1.7.2-src/dojo/dojo.js"></script>
    <script type="text/javascript">
    require({
        baseUrl : '../../..',
        packages: [
            { name: 'dojo', location: 'ThirdParty/dojo-release-1.7.2-src/dojo' },
            { name: 'dijit', location: 'ThirdParty/dojo-release-1.7.2-src/dijit' },
            { name: 'dojox', location: 'ThirdParty/dojo-release-1.7.2-src/dojox' },
            { name: 'Assets', location: 'Source/Assets' },
            { name: 'Core', location: 'Source/Core' },
            { name: 'DynamicScene', location: 'Source/DynamicScene' },
            { name: 'Renderer', location: 'Source/Renderer' },
            { name: 'Scene', location: 'Source/Scene' },
            { name: 'Shaders', location: 'Source/Shaders' },
            { name: 'ThirdParty', location: 'Source/ThirdParty' },
            { name: 'Widgets', location: 'Source/Widgets' },
            { name: 'Workers', location: 'Source/Workers' }
        ]
    });
    </script>
    <link rel="Stylesheet" href="../../../ThirdParty/dojo-release-1.7.2-src/dijit/themes/claro/claro.css" type="text/css">
    <link rel="Stylesheet" href="../../../Source/Widgets/Dojo/CesiumViewerWidget.css" type="text/css">
</head>
<body class="claro">
<style>
body {
    background: #000;
    color: #eee;
    font-family: sans-serif;
    font-size: 9pt;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
}
.fullSize {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    border: none;
    width: 100%;
    height: 100%;
    z-index: -1;
}
#toolbar {
    margin: 5px;
    padding: 2px 5px;
    position: absolute;
}
</style>

<div id="cesiumContainer" class="fullSize"></div>
<div id="toolbar">Loading...</div>

<script id="cesium_sandcastle_script">
require([
    'Source/Cesium', 'Widgets/Dojo/CesiumViewerWidget',
    'dojo/on', 'dojo/dom', 'dojo/io-query'
], function(
    Cesium, CesiumViewerWidget,
    on, dom, ioQuery)
{
    "use strict";

    var widget;
    var ellipsoid = Cesium.Ellipsoid.WGS84;
    var scene; 
    var cb;
    var mousePosition;

    function ellipsoidIntersections(ellipsoid, ray) {
        var position = ray.origin;
        var direction = ray.direction;
        var oneOverRadii = ellipsoid.getOneOverRadii();

        var scaledPosition = position.multiplyComponents(oneOverRadii);
        var scaledDirection = direction.multiplyComponents(oneOverRadii);

        var a = scaledDirection.magnitudeSquared();
        var b = 2.0 * scaledPosition.dot(scaledDirection);
        var c = scaledPosition.magnitudeSquared() - 1.0;

        var b2 = b * b;
        var four_ac = 4.0 * a * c;
        var radicand = b2 - four_ac;

        if (radicand < 0.0) {
            return undefined;
        }

        var q = -0.5 * (b + sign(b) * Math.sqrt(radicand));
        if (b > 0.0) {
            return [q / a, c / q];
        }
        return [c / q, q / a];
    }

    function sign(x) {
        if (x < 0.0) {
            return -1.0;
        } else if (x > 0.0) {
            return 1.0;
        }
        return 0.0;
    }
    
    function keydownHandler(e) {
        var position, direction, up;
        var camera = scene.getCamera();
        
        switch (e.keyCode) {
        case '2'.charCodeAt(0):
            widget.sceneTransitioner.toColumbusView();
            position = new Cesium.Cartesian3(2264.9817327431592, -13637202.637733376, 4211296.286087755);
            position = new Cesium.Cartesian3(position.y, position.z, position.x);
            direction = new Cesium.Cartesian3(-0.29586386622810074, 0.8547210238753364, -0.42651675700499164);
            direction = new Cesium.Cartesian3(direction.y, direction.z, direction.x);
            up = new Cesium.Cartesian3(0.9552301150293372, 0.2647331137639788, -0.13210528307421182);
            up = new Cesium.Cartesian3(up.y, up.z, up.x);
            camera.controller.lookAt(position, position.add(direction), up);
            break;
        case '3'.charCodeAt(0):
            widget.sceneTransitioner.to3D();
            position = new Cesium.Cartesian3(-2711464.1509439386, -4255314.2593585625, 3892009.8245821474);
            direction = new Cesium.Cartesian3(0.705822742123692, -0.48284733621560527, -0.5183364801077429);
            up = new Cesium.Cartesian3(-0.2257095701947508, -0.8468657216044324, 0.4815325944234253);
            camera.controller.lookAt(position, position.add(direction), up);
            break;
        case 'F'.charCodeAt(0):
            cb._surface.debugToggleLodUpdate();
            break;
        case 'B'.charCodeAt(0):
            var camera = scene.getCamera();
            var pickRay = camera.getPickRay(mousePosition);
            var intersectionDistance = ellipsoidIntersections(ellipsoid, pickRay)[0];
            var intersectionPoint = pickRay.getPoint(intersectionDistance);
            var cartographicPick = ellipsoid.cartesianToCartographic(intersectionPoint);
            cb._surface.debugShowBoundingSphereOfTileAt(cartographicPick);
            break;
        case 'V'.charCodeAt(0):
            var camera = scene.getCamera();
        	console.log('var position = new Cesium.Cartesian3' + camera.getPositionWC() + ';');
        	console.log('var direction = new Cesium.Cartesian3' + camera.getDirectionWC() + ';');
        	console.log('var up = new Cesium.Cartesian3' + camera.getUpWC() + ';');
            break;
        case 'L'.charCodeAt(0):
            var position = new Cesium.Cartesian3(1235514.4818091553, -4996224.532789806, 3894637.0982041876);
            var direction = new Cesium.Cartesian3(-0.19142739361697755, 0.7741020071546907, -0.6034249211725352);
            var up = new Cesium.Cartesian3(-0.022861502949612936, 0.6111110780404753, 0.791214637111247);
        	var camera = scene.getCamera();
            camera.lookAt(position, position.add(direction), up);
            break;
        case 'C'.charCodeAt(0):
            var position = new Cesium.Cartesian3(-2154047.1693888847, -5129769.958774299, 3112753.0357638514);
            var direction = new Cesium.Cartesian3(-0.6303093658511963, -0.09320311457302291, -0.7707290592381483);
            var up = new Cesium.Cartesian3(-0.36365569382280133, -0.8416695313076181, 0.3991828358266927);
            var camera = scene.getCamera();
            camera.lookAt(position, position.add(direction), up);
            break;
        }
    }

    // Ask Dojo to parse URL configuration options
    var endUserOptions = {};
    if (window.location.search) {
        endUserOptions = ioQuery.queryToObject(window.location.search.substring(1));
    }

    // Initialize a viewer capable of drag-and-drop
    // and user customizations.
    widget = new CesiumViewerWidget({
        endUserOptions : endUserOptions,
        enableDragDrop : true
    });
    widget.placeAt(dom.byId('cesiumContainer'));
    widget.startup();
    dom.byId('toolbar').innerHTML = '';

    scene = widget.scene;
    cb = scene.getPrimitives().getCentralBody();

    var terrainProvider = new Cesium.CesiumTerrainProvider({
        url : 'http://cesium.agi.com/terrain'
    });
    
    /*var terrainProvider = new Cesium.TileMapServiceTerrainProvider({
        url : 'http://cesium.agi.com/terrain'
    });*/    

    cb._surface._terrainProvider = terrainProvider;
    
    cb.oceanNormalMapUrl = require.toUrl('Assets/Textures/waterNormalsSmall.jpg');

    /*var terrainProvider = new Cesium.ArcGisImageServerTerrainProvider({
        url : 'http://elevation.arcgisonline.com/ArcGIS/rest/services/WorldElevation/DTMEllipsoidal/ImageServer',
        token : 'qV84HyuF8fxKlS3QNus8G9J4GxlA6R64C6WSMXcaZqnvvuAbWJARjvH9xt-axZ2cm7O8r11lCO6SxVYteypIKA..',
        proxy : new Cesium.DefaultProxy('/terrain/')
    });

    cb._surface._terrainProvider = terrainProvider;
    
    // TODO: this shouldn't be necessary
    var surface = cb._surface;
    var levelZeroTiles = surface._levelZeroTiles;
    for (var i = 0; i < levelZeroTiles.length; ++i) {
        levelZeroTiles[i].freeResources();
    }
    surface._levelZeroTiles = terrainProvider.tilingScheme.createLevelZeroTiles();*/

    scene.getCamera().frustum.near = 10.0;
    cb.affectedByLighting = false;
    
    /*var imageryLayerCollection = cb.getImageLayers();
    imageryLayerCollection.removeAll();
    
    var esriImageryProvider = new Cesium.ArcGisMapServerImageryProvider({
      url : 'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer',
      proxy : new Cesium.DefaultProxy('/proxy/')
    });
    var esriLayer = imageryLayerCollection.addImageryProvider(esriImageryProvider);

    var esriStreetsImageryProvider = new Cesium.ArcGisMapServerImageryProvider({
        url : 'http://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer',
        proxy : new Cesium.DefaultProxy('/proxy/')
    });
    var esriStreetsLayer = imageryLayerCollection.addImageryProvider(esriStreetsImageryProvider);*/

    document.addEventListener('keydown', keydownHandler, false);
    
    var handler = new Cesium.ScreenSpaceEventHandler(widget.canvas);

    handler.setInputAction(function(movement) {
        mousePosition = movement.endPosition;
        // Use movement.startPosition, movement.endPosition
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
});
</script>
</body>
</html>
